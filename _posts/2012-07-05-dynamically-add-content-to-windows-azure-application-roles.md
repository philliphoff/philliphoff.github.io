---
layout: post
title: "Dynamically Add Content to Windows Azure Application Roles"
date: 2012-07-05
---
<p>In a previous <a href="{% post_url 2012-06-08-add-files-to-your-windows-azure-package-using-role-content-folders %}">post</a> I introduced the concept of Role Content Folders and how they can be used to deploy additional content (e.g. configuration files, runtime components, etc.) to the virtual machine for a Windows Azure application role.&nbsp; That post was written from the perspective of a developer working within Visual Studio and works great when the content is relatively static and specific to a single project.&nbsp; However, this feature works less well in cases where the content is more dynamic (i.e. where the additional content is not known until package-time) or when the content is used across several roles or applications.&nbsp; Fortunately, the packaging of Role Content Folders within Visual Studio is built upon more general MSBuild infrastructure which we can extend to package additional, arbitrary content.</p>
<p>In v1.7, the targets file for Windows Azure projects contains a new packaging phase (i.e. high-level target) called <span style="font-family: Courier New;" face="Courier New">AddRoleContent</span>.&nbsp; In this phase, various sub-targets identify the Role Content Folders defined by the project file, prepare the files within those folders for packaging, and then inject appropriate elements into the Service Definition (.csdef) file such that those files will be packaged when the process invokes CSPack.&nbsp; The <span style="font-family: Courier New;" face="Courier New">AzureRoleContent</span> MSBuild item group ultimately determines what folders will be packaged and for which roles.&nbsp; An <span style="font-family: Courier New;" face="Courier New">AzureRoleContent</span> item contains the following metadata:</p>
<ul>
<li><strong><span style="font-family: Courier New;" face="Courier New">Identity</span> (i.e. <span style="font-family: Courier New;" face="Courier New">Include</span>):</strong> This metadata specifies the source folder of the content to package</li>
<li><strong><span style="font-family: Courier New;" face="Courier New">RoleName</span>:</strong> This metadata specifies the name of the role to which the content should be deployed; the content will be deployed to all instances of that role.</li>
<li><strong><span style="font-family: Courier New;" face="Courier New">Destination</span>:</strong> (Optional) This metadata specifies the location to which the content should be deployed (relative to <span style="font-family: Courier New;" face="Courier New">APPROOT</span>).&nbsp; If omitted, the content is deployed directly to <span style="font-family: Courier New;" face="Courier New">APPROOT</span>.</li>
</ul>
<p>To inject additional content into the package, one must add new <span style="font-family: Courier New;" face="Courier New">AzureRoleContent</span> items prior to the last step of this packaging phase.&nbsp; A convenient place to do this is within an override of the <span style="font-family: Courier New;" face="Courier New">BeforeAddRoleContent</span> target.&nbsp; An alternative is to add a custom target to the beginning of the target list <span style="font-family: Courier New;" face="Courier New">CoreAddRoleContentDependsOn</span> MSBuild property.&nbsp; This latter approach can be useful for cases where you customize many Windows Azure projects in the same way, as it ensures that individual Azure projects do not interfere with the customization if a project were to independently override the <span style="font-family: Courier New;" face="Courier New">BeforeAddRoleContent</span> target.</p>
<p>Let&rsquo;s suppose we have the following:</p>
<ul>
<li>A Visual Studio solution with a Windows Azure project, DynamicRoleContentFolderTest, containing two roles:</li>
<ul>
<li>A web role named MyWebRole</li>
<li>A worker role named MyWorkerRole</li>
</ul>
<li>An additional folder of content, <span style="font-family: Courier New;" face="Courier New">AdditionalContent</span>, to be deployed only to the web role:</li>
<ul>
<li>Located within the DynamicRoleContentFolderTest project</li>
<li>Contains a single file, <span style="font-family: Courier New;" face="Courier New">AdditionalContent.xml</span></li>
</ul>
</ul>
<p>The first step is to edit the Windows Azure project file and override the <span style="font-family: Courier New;" face="Courier New">BeforeAddRoleContent</span> target.&nbsp; Next, the target will create a new item group, <span style="font-family: Courier New;" face="Courier New">AzureRoleContent</span>, that includes the <span style="font-family: Courier New;" face="Courier New">AdditionalContent</span> folder.&nbsp; We&rsquo;ll then add metadata to the item group to specify that it be deployed with the web role, MyWebRole, as well as deployed to the <span style="font-family: Courier New;" face="Courier New">APPROOT\AdditionalContent</span> folder.&nbsp; In the end, we will have a project file that looks something like:</p>
<p><span style="font-family: Courier New;" face="Courier New">. <br /> . <br /> . <br />&lt;Import Project="$(CloudExtensionsDir)Microsoft.WindowsAzure.targets" /&gt; <br />&lt;Target Name="BeforeAddRoleContent"&gt; <br />&nbsp; &lt;ItemGroup&gt; <br />&nbsp;&nbsp;&nbsp; &lt;AzureRoleContent Include="AdditionalContent"&gt; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;RoleName&gt;MyWebRole&lt;/RoleName&gt; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;Destination&gt;AdditionalContent&lt;/Destination&gt; <br />&nbsp;&nbsp;&nbsp; &lt;/AzureRoleContent&gt; <br />&nbsp; &lt;/ItemGroup&gt; <br />&lt;/Target&gt; <br /> . <br /> . <br />.</span></p>
<p>When a package is built and/or deployed you will then see the <span style="font-family: Courier New;" face="Courier New">AdditionalContent</span> folder, with its <span style="font-family: Courier New;" face="Courier New">AdditionalContent.xml</span> file, in the package layout and/or on the virtual machine.</p>
<p><a href="/assets/posts/4314.AdditionalContent_07546AB9.png"><img width="253" height="409" title="AdditionalContent" style="display: inline; background-image: none;" alt="AdditionalContent" src="/assets/posts/5875.AdditionalContent_thumb_00A16136.png" border="0" /></a></p>
<p>Now what would happen if we omitted the <span style="font-family: Courier New;" face="Courier New">Destination</span> metadata from the item group, as in the following example?</p>
<p><span style="font-family: Courier New;" face="Courier New">. <br /> . <br /> . <br />&lt;AzureRoleContent Include="AdditionalContent"&gt; <br />&nbsp; &lt;RoleName&gt;MyWebRole&lt;/RoleName&gt; <br />&nbsp; &lt;!--&lt;Destination&gt;AdditionalContent&lt;/Destination&gt;--&gt; <br />&lt;/AzureRoleContent&gt; <br /> . <br /> . <br /> .</span></p>
<p>In this example, the content in the <span style="font-family: Courier New;" face="Courier New">AdditionalContent</span> folder will deployed directly to <span style="font-family: Courier New;" face="Courier New">APPROOT</span>, with no corresponding subfolder.&nbsp; This can be very useful when you need to deploy a configuration file to <span style="font-family: Courier New;" face="Courier New">APPROOT</span>.&nbsp; However, note that this can result in name collisions between files deployed by the role project and files deployed through this Role Content Folder mechanism.&nbsp; You will not get any warnings or errors from CSPack (or the Tools) when this happens, so beware!</p>
<p><a href="/assets/posts/8117.AdditionalContentInAppRoot_20BC6DF3.png"><img width="250" height="405" title="AdditionalContentInAppRoot" style="display: inline; background-image: none;" alt="AdditionalContentInAppRoot" src="/assets/posts/3302.AdditionalContentInAppRoot_thumb_55C8FD23.png" border="0" /></a></p>
<p>Role Content Folders can be a great option when you have additional content to deploy to a role of a Windows Azure application, whether used to deploy static content within Visual Studio or used in conjunction with the underlying infrastructure to deploy more dynamic content.</p>