---
layout: posts
title: "Extending LINQ to DASL with Custom DASL Properties"
date: 2008-02-20
---
<P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">In an earlier </FONT><A href="{% post_url 2008-02-18-query-your-outlook-inbox-with-linq-to-dasl %}"><FONT face="Times New Roman">post</FONT></A><FONT face="Times New Roman"> I discussed LINQ to DASL, part of the Office Interop API Extensions, which is one of the forthcoming VSTO Power Tools.&nbsp; LINQ to DASL allows you to write LINQ expressions against Outlook item collections.&nbsp; I also mentioned that many known DASL properties were not mapped to their Outlook item equivalents in this initial release.&nbsp; So how do you write&nbsp;LINQ expressions using DASL properties that weren't included?&nbsp; The answer is: by extending the base LINQ to DASL&nbsp;classes.&nbsp; Let's start with a non-LINQ example:<?xml:namespace prefix = o ns = "urn:schemas-microsoft-com:office:office" /><o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 0.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">Outlook.<SPAN style="COLOR: #2b91af">Folder</SPAN> folder = (Outlook.<SPAN style="COLOR: #2b91af">Folder</SPAN>) <SPAN style="COLOR: blue">this</SPAN>.Application.Session.GetDefaultFolder(Outlook.<SPAN style="COLOR: #2b91af">OlDefaultFolders</SPAN>.olFolderInbox);<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 0.5in"><FONT face="Times New Roman"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Arial','sans-serif'">var</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"> topics = <SPAN style="COLOR: blue">new</SPAN> <SPAN style="COLOR: #2b91af">List</SPAN>&lt;<SPAN style="COLOR: blue">string</SPAN>&gt;();<o:p></o:p></SPAN></FONT></P>
<P style="MARGIN-LEFT: 0.5in"><FONT face="Times New Roman"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Arial','sans-serif'">foreach</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"> (<SPAN style="COLOR: blue">object</SPAN> item <SPAN style="COLOR: blue">in</SPAN> folder.Items)<o:p></o:p></SPAN></FONT></P>
<P style="MARGIN-LEFT: 0.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">{<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 1in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">Outlook.<SPAN style="COLOR: #2b91af">MailItem</SPAN> mailItem = item <SPAN style="COLOR: blue">as</SPAN> Outlook.<SPAN style="COLOR: #2b91af">MailItem</SPAN>;<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 1in"><FONT face="Times New Roman"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Arial','sans-serif'">if</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"> (mailItem != <SPAN style="COLOR: blue">null</SPAN>)<o:p></o:p></SPAN></FONT></P>
<P style="MARGIN-LEFT: 1in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">{<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 1.5in"><FONT face="Times New Roman"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Arial','sans-serif'">if</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"> (mailItem.ConversationTopic.Contains(<SPAN style="COLOR: #a31515">"VSTO"</SPAN>))<o:p></o:p></SPAN></FONT></P>
<P style="MARGIN-LEFT: 1.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">{<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 2in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">topics.Add(mailItem.ConversationTopic);<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 1.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">}<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 1in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">}<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 0.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">}<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 0.5in"><FONT face="Times New Roman"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Arial','sans-serif'">foreach</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"> (<SPAN style="COLOR: blue">var</SPAN> topic <SPAN style="COLOR: blue">in</SPAN> topics)<o:p></o:p></SPAN></FONT></P>
<P style="MARGIN-LEFT: 0.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">{<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 1in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">System.Diagnostics.<SPAN style="COLOR: #2b91af">Debug</SPAN>.WriteLine(<SPAN style="COLOR: #2b91af">String</SPAN>.Format(<SPAN style="COLOR: #a31515">"Conversation Topic: {0}"</SPAN>, topic));<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 0.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">}<o:p></o:p></FONT></SPAN></P>
<P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">The example shows&nbsp;our first attempt to find all mail items with a conversation index containing the acronym "VSTO".&nbsp; It simply iterates over each item in the folder, checks whether it's a mail item, then checks whether it has a matching conversation topic.&nbsp; Iterating over each and every item in the folder is not very efficient.&nbsp; We can have Outlook&nbsp;perform the filtration in its own native (and presumably more efficient) way.&nbsp; We do this by creating a DASL query&nbsp;string and passing it to the Items.Restrict() method.&nbsp; Here is the updated example:<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 0.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">Outlook.<SPAN style="COLOR: #2b91af">Folder</SPAN> folder = (Outlook.<SPAN style="COLOR: #2b91af">Folder</SPAN>) <SPAN style="COLOR: blue">this</SPAN>.Application.Session.GetDefaultFolder(Outlook.<SPAN style="COLOR: #2b91af">OlDefaultFolders</SPAN>.olFolderInbox);<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 0.5in"><FONT face="Times New Roman"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Arial','sans-serif'">string</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"> filter = <SPAN style="COLOR: #a31515">@"@SQL=(""urn:schemas:httpmail:thread-topic"" LIKE '%VSTO%')"</SPAN>;<o:p></o:p></SPAN></FONT></P>
<P style="MARGIN-LEFT: 0.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">Outlook.<SPAN style="COLOR: #2b91af">Items</SPAN> items = folder.Items.Restrict(filter);<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 0.5in"><FONT face="Times New Roman"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Arial','sans-serif'">var</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"> topics = <SPAN style="COLOR: blue">new</SPAN> <SPAN style="COLOR: #2b91af">List</SPAN>&lt;<SPAN style="COLOR: blue">string</SPAN>&gt;();<o:p></o:p></SPAN></FONT></P>
<P style="MARGIN-LEFT: 0.5in"><FONT face="Times New Roman"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Arial','sans-serif'">foreach</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"> (<SPAN style="COLOR: blue">object</SPAN> item <SPAN style="COLOR: blue">in</SPAN> items)<o:p></o:p></SPAN></FONT></P>
<P style="MARGIN-LEFT: 0.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">{<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 1in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">Outlook.<SPAN style="COLOR: #2b91af">MailItem</SPAN> mailItem = item <SPAN style="COLOR: blue">as</SPAN> Outlook.<SPAN style="COLOR: #2b91af">MailItem</SPAN>;<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 1in"><FONT face="Times New Roman"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Arial','sans-serif'">if</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"> (mailItem != <SPAN style="COLOR: blue">null</SPAN>)<o:p></o:p></SPAN></FONT></P>
<P style="MARGIN-LEFT: 1in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">{<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 1.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">topics.Add(mailItem.ConversationTopic);<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 1in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">}<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 0.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">}<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 0.5in"><FONT face="Times New Roman"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Arial','sans-serif'">foreach</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"> (<SPAN style="COLOR: blue">var</SPAN> topic <SPAN style="COLOR: blue">in</SPAN> topics)<o:p></o:p></SPAN></FONT></P>
<P style="MARGIN-LEFT: 0.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">{<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 1in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">System.Diagnostics.<SPAN style="COLOR: #2b91af">Debug</SPAN>.WriteLine(<SPAN style="COLOR: #2b91af">String</SPAN>.Format(<SPAN style="COLOR: #a31515">"Conversation Topic: {0}"</SPAN>, topic));<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 0.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">}<o:p></o:p></FONT></SPAN></P>
<P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">The&nbsp;collection returned by Items.Restrict() is the subset of items matching the filter.&nbsp; It may be more efficient, but it certainly doesn't simplify the code.&nbsp; It would be nice if we could use a strongly-typed LINQ expression.&nbsp; Unfortunately, the Mail class in the initial&nbsp;LINQ to DASL implementation does not have a property which maps to the "urn:schemas:httpmail:thread-topic" DASL property.&nbsp; We can extend the Mail class to do so, however, as shown below:<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 0.5in"><FONT face="Times New Roman"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Arial','sans-serif'">internal</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"> <SPAN style="COLOR: blue">class</SPAN> <SPAN style="COLOR: #2b91af">MyMail</SPAN> : <SPAN style="COLOR: #2b91af">Mail<o:p></o:p></SPAN></SPAN></FONT></P>
<P style="MARGIN-LEFT: 0.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">{<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 1in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">[<SPAN style="COLOR: #2b91af">OutlookItemProperty</SPAN>(<SPAN style="COLOR: #a31515">"urn:schemas:httpmail:thread-topic"</SPAN>)]<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 1in"><FONT face="Times New Roman"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Arial','sans-serif'">public</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"> <SPAN style="COLOR: blue">string</SPAN> ConversationTopic<o:p></o:p></SPAN></FONT></P>
<P style="MARGIN-LEFT: 1in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">{ <SPAN style="COLOR: blue">get</SPAN> { <SPAN style="COLOR: blue">return</SPAN> Item.ConversationTopic; } }<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 0.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">}<o:p></o:p></FONT></SPAN></P>
<P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">We create a new class, MyMail, which inherits from the existing LINQ to DASL Mail class.&nbsp; We then add a ConversationTopic property which simply delegates to&nbsp;the ConversationTopic property on the Outlook.MailItem reference held by the Mail class.&nbsp; The key piece is the OutlookItemPropertyAttribute attached to the property.&nbsp; This attribute&nbsp;provides&nbsp;the mapping between&nbsp;the property&nbsp;as used in a LINQ expression and the DASL property in the query string.&nbsp; With that, we can finally write our LINQ expression:<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 0.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">Outlook.<SPAN style="COLOR: #2b91af">Folder</SPAN> folder = (Outlook.<SPAN style="COLOR: #2b91af">Folder</SPAN>) <SPAN style="COLOR: blue">this</SPAN>.Application.Session.GetDefaultFolder(Outlook.<SPAN style="COLOR: #2b91af">OlDefaultFolders</SPAN>.olFolderInbox);<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 0.5in"><FONT face="Times New Roman"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Arial','sans-serif'">var</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"> topics = <o:p></o:p></SPAN></FONT></P>
<P style="MARGIN-LEFT: 1in"><FONT face="Times New Roman"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Arial','sans-serif'">from</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"> item <SPAN style="COLOR: blue">in</SPAN> folder.Items.AsQueryable&lt;<SPAN style="COLOR: #2b91af">MyMail</SPAN>&gt;()<o:p></o:p></SPAN></FONT></P>
<P style="MARGIN-LEFT: 1in"><FONT face="Times New Roman"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Arial','sans-serif'">where</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"> item.ConversationTopic.Contains(<SPAN style="COLOR: #a31515">"VSTO"</SPAN>)<o:p></o:p></SPAN></FONT></P>
<P style="MARGIN-LEFT: 1in"><FONT face="Times New Roman"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Arial','sans-serif'">select</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"> item.ConversationTopic;<o:p></o:p></SPAN></FONT></P>
<P style="MARGIN-LEFT: 0.5in"><FONT face="Times New Roman"><SPAN style="FONT-SIZE: 10pt; COLOR: blue; FONT-FAMILY: 'Arial','sans-serif'">foreach</SPAN><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"> (<SPAN style="COLOR: blue">var</SPAN> topic <SPAN style="COLOR: blue">in</SPAN> topics)<o:p></o:p></SPAN></FONT></P>
<P style="MARGIN-LEFT: 0.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">{<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 1in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">System.Diagnostics.<SPAN style="COLOR: #2b91af">Debug</SPAN>.WriteLine(<SPAN style="COLOR: #2b91af">String</SPAN>.Format(<SPAN style="COLOR: #a31515">"Conversation Topic: {0}"</SPAN>, topic));<o:p></o:p></FONT></SPAN></P>
<P style="MARGIN-LEFT: 0.5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">}<o:p></o:p></FONT></SPAN></P>
<P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: 'Arial','sans-serif'"><FONT face="Times New Roman">Extensions to LINQ to DASL are not limited to the addition of new DASL properties.&nbsp; You can also extend the LINQ to DASL classes to allow strongly-typed query expressions&nbsp;using custom user properties.&nbsp; I'll discuss that topic in a future post.<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0in 0in 0pt"><o:p><FONT face="Times New Roman" size=3>&nbsp;</FONT></o:p></P>